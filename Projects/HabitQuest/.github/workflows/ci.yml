# Generated by AI-Enhanced Automation
# Tue Sep 23 19:56:27 CDT 2025

Here's a comprehensive GitHub Actions CI/CD workflow for your HabitQuest Swift project:

```yaml
# .github/workflows/ci-cd.yml
name: HabitQuest CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '**.txt'
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1' # Weekly dependency updates (Monday 2 AM UTC)
  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
  SCHEME: "HabitQuest"
  DESTINATION: "platform=iOS Simulator,OS=17.2,name=iPhone 15 Pro"
  MAC_DESTINATION: "platform=macOS"
  SWIFT_VERSION: "5.9"
  DERIVED_DATA_PATH: "/tmp/derivedData"
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Code Quality & Formatting
    runs-on: macos-14
    timeout-minutes: 15
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for better analysis

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Caches/org.swift.swiftpm
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Install Swift Tools
      run: |
        brew install swiftlint swiftformat ollama || echo "Tools installation completed"

    - name: SwiftLint Analysis
      run: |
        if command -v swiftlint &> /dev/null; then
          echo "Running SwiftLint..."
          swiftlint lint --reporter checkstyle > swiftlint-report.xml || true
        else
          echo "SwiftLint not available"
        fi

    - name: SwiftFormat Check
      run: |
        if command -v swiftformat &> /dev/null; then
          echo "Running SwiftFormat..."
          swiftformat . --lint --verbose || exit 1
        else
          echo "SwiftFormat not available"
        fi

    - name: AI Code Analysis (Optional)
      if: always()
      run: |
        if command -v ollama &> /dev/null; then
          echo "Starting Ollama service..."
          ollama serve &
          sleep 10
          ollama pull llama2 || echo "Model download failed"
          
          # Run AI analysis on changed files
          git diff --name-only HEAD~1 HEAD | grep '\.swift$' | while read file; do
            if [ -f "$file" ]; then
              echo "Analyzing $file with AI..."
              ollama run llama2 "Analyze this Swift code for best practices and potential issues: $(head -n 50 $file)" || true
            fi
          done
        else
          echo "Ollama not available for AI analysis"
        fi

    - name: Upload Code Quality Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: |
          swiftlint-report.xml
          !**/*.md

  # Job 2: Security Scanning
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Run Security Scan
      uses: anchore/scan-action@v3
      id: scan
      with:
        path: "."
        fail-build: false
        severity-cutoff: "medium"
        output-format: "sarif"

    - name: Upload Security Report
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: ${{ steps.scan.outputs.sarif }}

  # Job 3: Build & Test (iOS)
  build-test-ios:
    name: Build & Test (iOS)
    needs: [code-quality]
    runs-on: macos-14
    timeout-minutes: 30
    
    strategy:
      matrix:
        xcode: ['15.0', '15.2']
        ios-version: ['16.4', '17.2']
        device: ['iPhone 15 Pro', 'iPhone SE (3rd generation)']
      fail-fast: false

    env:
      DESTINATION: "platform=iOS Simulator,OS=${{ matrix.ios-version }},name=${{ matrix.device }}"

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ matrix.xcode }}

    - name: Cache Derived Data
      uses: actions/cache@v3
      with:
        path: ${{ env.DERIVED_DATA_PATH }}
        key: ${{ runner.os }}-deriveddata-ios-${{ matrix.xcode }}-${{ matrix.ios-version }}-${{ hashFiles('**/*.swift') }}

    - name: Resolve Dependencies
      run: |
        xcodebuild -resolvePackageDependencies -scheme "$SCHEME" -project HabitQuest.xcodeproj

    - name: Build for Testing
      run: |
        xcodebuild build-for-testing \
          -project HabitQuest.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DESTINATION" \
          -derivedDataPath "$DERIVED_DATA_PATH" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Run Tests with Coverage
      run: |
        xcodebuild test-without-building \
          -project HabitQuest.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DESTINATION" \
          -derivedDataPath "$DERIVED_DATA_PATH" \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Process Code Coverage
      run: |
        xcrun llvm-cov export -format="lcov" \
          "$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator/HabitQuest.app/HabitQuest" \
          -instr-profile "$DERIVED_DATA_PATH/Build/ProfileData/*/Coverage.profdata" \
          > coverage.lcov || echo "Coverage processing failed"

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-ios-xcode${{ matrix.xcode }}-ios${{ matrix.ios-version }}
        path: |
          TestResults/
          coverage.lcov
          ${{ env.DERIVED_DATA_PATH }}/Logs/Test/

  # Job 4: Build & Test (macOS)
  build-test-macos:
    name: Build & Test (macOS)
    needs: [code-quality]
    runs-on: macos-14
    timeout-minutes: 25
    
    strategy:
      matrix:
        xcode: ['15.0', '15.2']
      fail-fast: false

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ matrix.xcode }}

    - name: Cache Derived Data
      uses: actions/cache@v3
      with:
        path: ${{ env.DERIVED_DATA_PATH }}
        key: ${{ runner.os }}-deriveddata-macos-${{ matrix.xcode }}-${{ hashFiles('**/*.swift') }}

    - name: Build for Testing (macOS)
      run: |
        xcodebuild build-for-testing \
          -project HabitQuest.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$MAC_DESTINATION" \
          -derivedDataPath "$DERIVED_DATA_PATH" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Run Tests (macOS)
      run: |
        xcodebuild test-without-building \
          -project HabitQuest.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$MAC_DESTINATION" \
          -derivedDataPath "$DERIVED_DATA_PATH" \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Upload macOS Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-macos-xcode${{ matrix.xcode }}
        path: TestResults/

  # Job 5: Performance Benchmarking
  performance-benchmark:
    name: Performance Benchmarking
    needs: [build-test-ios, build-test-macos]
    runs-on: macos-14
    timeout-minutes: 20
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Run Performance Tests
      run: |
        # Create benchmark script
        cat > benchmark.sh << 'EOF'
        #!/bin/bash
        echo "Starting performance benchmark..."
        
        # Memory usage test
        echo "Testing memory usage..."
        /usr/bin/time -l xcodebuild test \
          -project HabitQuest.xcodeproj \
          -scheme "HabitQuest-PerformanceTests" \
          -destination "$DESTINATION" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO 2>&1 | tee memory-test.log
        
        # CPU performance test
        echo "Testing CPU performance..."
        xcodebuild test \
          -project HabitQuest.xcodeproj \
          -scheme "HabitQuest-PerformanceTests" \
          -destination "$DESTINATION" \
          -enableCodeCoverage NO 2>&1 | tee cpu-test.log
        
        echo "Benchmark completed"
        EOF
        
        chmod +x benchmark.sh
        ./benchmark.sh

    - name: Analyze Performance Results
      run: |
        # Parse benchmark results (simplified example)
        if [ -f memory-test.log ]; then
          echo "Memory usage analysis:"
          grep "maximum resident set size" memory-test.log || echo "No memory data found"
        fi

    - name: Upload Benchmark Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-benchmark-results
        path: |
          *.log
          *.json

  # Job 6: Artifact Generation
  generate-artifacts:
    name: Generate Build Artifacts
    needs: [build-test-ios, build-test-macos]
    runs-on: macos-14
    timeout-minutes: 20
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Build iOS App
      run: |
        xcodebuild archive \
          -project HabitQuest.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DESTINATION" \
          -archivePath "HabitQuest-iOS.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Export iOS IPA
      run: |
        # Create export options plist
        cat > exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath "HabitQuest-iOS.xcarchive" \
          -exportPath "." \
          -exportOptionsPlist exportOptions.plist

    - name: Build macOS App
      run: |
        xcodebuild archive \
          -project HabitQuest.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$MAC_DESTINATION" \
          -archivePath "HabitQuest-macOS.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create Release Assets
      run: |
        # Package apps for release
        mkdir -p release-assets
        
        if [ -f "HabitQuest-iOS.ipa" ]; then
          cp "HabitQuest-iOS.ipa" release-assets/
        fi
        
        if [ -d "HabitQuest-iOS.xcarchive" ]; then
          zip -r release-assets/HabitQuest-iOS.xcarchive.zip HabitQuest-iOS.xcarchive
        fi
        
        if [ -d "HabitQuest-macOS.xcarchive" ]; then
          zip -r release-assets/HabitQuest-macOS.xcarchive.zip HabitQuest-macOS.xcarchive
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: habitquest-build-artifacts
        path: release-assets/

  # Job 7: Dependency Updates
  dependency-update:
    name: Dependency Updates
    runs-on: macos-14
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 15
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }} # Personal access token for pushing changes

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Update Swift Packages
      run: |
        # Update package dependencies
        if [ -f "Package.swift" ]; then
          swift package update
        fi
        
        # Update CocoaPods if used
        if [ -f "Podfile" ]; then
          pod update
        fi

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GH_PAT }}
        commit-message: "chore: update dependencies"
        title: "Dependency Updates"
        body: |
          ## Dependency Updates
          
          This PR updates project dependencies to their latest versions.
          
          Please review and test before merging.
        branch: dependency-updates
        delete-branch: true

  # Job 8: Notifications & Reporting
  notify-and-report:
    name: Notifications & Reporting
    needs: [code-quality, security-scan, build-test-ios, build-test-macos, performance-benchmark, generate-artifacts]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Generate Summary Report
      run: |
        echo "## üöÄ HabitQuest CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| iOS Build & Test | ${{ needs.build-test-ios.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS Build & Test | ${{ needs.build-test-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Benchmark | ${{ needs.performance-benchmark.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact Generation | ${{ needs.generate-artifacts.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Send Slack Notification
      if: env.SLACK_WEBHOOK_URL != ''
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        channel: '#ci-cd-notifications'
        username: 'HabitQuest CI/CD'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Send Discord Notification
      if: env.DISCORD_WEBHOOK_URL != '' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          STATUS_MSG="‚úÖ Build Successful"
          COLOR="00ff00"
        elif [ "${{ job.status }}" == "failure" ]; then
          STATUS_MSG="‚ùå Build Failed"
          COLOR="ff0000"
        else
          STATUS_MSG="‚ö†Ô∏è Build Cancelled"
          COLOR="ffff00"
        fi
        
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{
            \"embeds\": [{
              \"title\": \"HabitQuest CI/CD Pipeline\",
              \"description\": \"$STATUS_MSG for ${{ github.ref }}\",
              \"color\": \"$COLOR\",
              \"fields\": [
                {\"name\": \"Commit\", \"value\": \"${{ github.sha }}\", \"inline\": true},
                {\"name\": \"Author\", \"value\": \"${{ github.actor }}\", \"inline\": true}
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

  # Job 9: Code Coverage Reporting
  coverage-report:
    name: Code Coverage Report
    needs: [build-test-ios, build-test-macos]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Download Coverage Data
      uses: actions/download-artifact@v4
      with:
        name: test-results-ios-xcode15.2-ios17.2 # Latest version coverage

    - name: Upload to Codecov
      if: env.CODECOV_TOKEN != ''
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.lcov
        flags: unittests
        name: habitquest-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

# Workflow-level concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

## Key Features of this CI/CD Pipeline:

### 1. **Multi-Platform Support**
- Builds and tests on both iOS and macOS
- Multiple Xcode and OS versions
- Device matrix testing

### 2. **Comprehensive Code Quality**
- SwiftLint for static analysis
- SwiftFormat for code formatting
- AI-enhanced analysis with Ollama (optional)

### 3. **Robust Testing**
- Unit and integration tests
- Code coverage reporting
- Performance benchmarking
- Security vulnerability scanning

### 4. **Artifact Management**
- iOS IPA generation
- macOS app archives
- Xcode archives for App Store submission

### 5. **Automated Dependency Updates**
- Weekly scheduled updates
- Automatic PR creation
- Version conflict resolution

### 6. **Production-Ready Features**
- Comprehensive error handling
- Slack/Discord notifications
- Detailed reporting and summaries
- Caching for faster builds
- Timeout management
- Concurrency control

### 7. **Security & Compliance**
- Security scanning with Anchore
- Code signing management
- Dependency vulnerability checks

## Setup Requirements:

1. **Secrets to Configure**:
   - `GH_PAT` (GitHub Personal Access Token)
   - `SLACK_WEBHOOK_URL` (optional)
   - `DISCORD_WEBHOOK_URL` (optional)
   - `CODECOV_TOKEN` (optional)

2. **Project Structure**:
   - Xcode project named `HabitQuest.xcodeproj`
   - Scheme named `HabitQuest`
   - Optional: Performance test scheme

3. **Customization Points**:
   - Adjust Xcode versions in matrix
   - Modify device matrix for iOS testing
   - Update scheme names to match your project
   - Configure notification channels

This workflow provides enterprise-grade CI/CD with comprehensive testing, quality assurance, and deployment preparation for your Swift application.
